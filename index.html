<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; background-color: #f4f4f4; }
        #qr-reader { width: 80%; max-width: 500px; margin: 20px auto; border: 2px solid #ccc; }
        #status-message { font-size: 1.2em; color: #333; margin-top: 20px; }
        a { color: #007bff; }
    </style>
</head>
<body>
    <h1>Scan Asset QR Code</h1>
    <div id="qr-reader"></div>
    <div id="status-message">Loading data and waiting for scan...</div>

    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

<script>

        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR6zF-a_i25R8N3SpcQ1oF-lWTKxCo1hM3bFfV6M4rBq0K8TfPQuzFw3f_kE8wG8n_5k-qV8iWfWq8i/pub?gid=0&single=true&output=csv'; // This is your URL, I've put it here for you.

        // This object will store our asset data: { "AssetID": "PDF_Link", ... }
        const assetData = new Map();

        const statusMessageEl = document.getElementById('status-message');

        // Function to fetch and parse the CSV data from Google Sheets
        async function loadAssetData() {
            // Camera access requires HTTPS, which GitHub Pages provides. Let's check.
            if (location.protocol !== 'https:') {
                statusMessageEl.textContent = 'ERROR: Camera access requires a secure connection (HTTPS).';
                statusMessageEl.style.color = 'red';
                return;
            }
            
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                const csvData = await response.text();
                
                const rows = csvData.trim().split('\n').slice(1);

                for (const row of rows) {
                    // This handles cases where your other columns might have commas
                    const columns = row.split(',');
                    const assetId = columns[0];
                    const pdfLink = columns[1];

                    if (assetId && pdfLink) {
                        assetData.set(assetId.trim(), pdfLink.trim());
                    }
                }
                
                console.log('Asset data loaded successfully:', assetData);
                statusMessageEl.textContent = 'Ready to scan. Please grant camera permission.';
            } catch (error) {
                console.error('Failed to load asset data:', error);
                statusMessageEl.textContent = 'Error: Could not load asset data. Please check the URL and your internet connection.';
                statusMessageEl.style.color = 'red';
            }
        }

        // Function that runs when a QR code is successfully scanned
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result: ${decodedText}`);
            
            if (assetData.has(decodedText)) {
                const pdfUrl = assetData.get(decodedText);
                
                // We need to stop the scanner before redirecting. We access it from the global scope.
                scanner.clear().catch(error => {
                    console.error("Failed to clear html5QrcodeScanner.", error);
                });

                statusMessageEl.textContent = `Asset Found! Redirecting to PDF...`;
                window.location.href = pdfUrl;

            } else {
                statusMessageEl.textContent = `Error: Asset ID "${decodedText}" not found in the database.`;
                statusMessageEl.style.color = 'orange';

                setTimeout(() => {
                    statusMessageEl.textContent = 'Ready to scan. Please grant camera permission.';
                    statusMessageEl.style.color = '#333';
                }, 3000);
            }
        }
        
        function onScanFailure(error) {
            // This is not a real error, just means no QR code was found in a frame.
        }

        // We need a global variable for the scanner so we can access it in onScanSuccess
        let scanner; 

        // When the document is ready, load the data and initialize the scanner
        document.addEventListener('DOMContentLoaded', () => {
            // First, load the data from your Google Sheet
            loadAssetData(); 
            
            // Then, create the scanner object and render it
            scanner = new Html5QrcodeScanner(
                "qr-reader", 
                { fps: 10, qrbox: { width: 250, height: 250 } }
            );
            scanner.render(onScanSuccess, onScanFailure);
        });

    </script>
</body>
</html>
