<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; background-color: #f4f4f4; }
        #qr-reader { width: 80%; max-width: 500px; margin: 20px auto; border: 2px solid #ccc; }
        #status-message { font-size: 1.2em; color: #333; margin-top: 20px; }
        a { color: #007bff; }
    </style>
</head>
<body>
    <h1>Scan Asset QR Code</h1>
    <div id="qr-reader"></div>
    <div id="status-message">Loading data and waiting for scan...</div>

    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

<script>
        // --- CONFIGURATION ---
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRdR8paF1wZmHbekRDv3ff3pl7ZQ3fvU-lS2X8nUdWVlhJFWI8EFqAHtWZCtcRW1FAIeIAlgRbtXtcJ/pub?gid=0&single=true&output=csv;
        const assetData = new Map();
        const statusMessageEl = document.getElementById('status-message');
        const scannerEl = document.getElementById('qr-reader');
        let scanner; // Will hold the scanner object

        // This function now returns 'true' on success and 'false' on failure
        async function loadAssetData() {
            statusMessageEl.textContent = 'Connecting to asset database...';
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                const csvData = await response.text();
                
                const rows = csvData.trim().split('\n').slice(1);
                if (rows.length === 0) {
                    throw new Error("CSV file is empty or has only a header.");
                }

                for (const row of rows) {
                    const columns = row.split(',');
                    const assetId = columns[0];
                    const pdfLink = columns[1];

                    if (assetId && pdfLink) {
                        assetData.set(assetId.trim(), pdfLink.trim());
                    }
                }
                
                console.log(`Asset data loaded successfully. Found ${assetData.size} assets.`);
                statusMessageEl.textContent = 'Database loaded. Starting camera...';
                return true; // Indicate success

            } catch (error) {
                console.error('Failed to load asset data:', error);
                statusMessageEl.textContent = 'Error: Could not load asset database. Please check connection and refresh.';
                statusMessageEl.style.color = 'red';
                return false; // Indicate failure
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result: ${decodedText}`);
            
            if (assetData.has(decodedText)) {
                const pdfUrl = assetData.get(decodedText);
                
                statusMessageEl.textContent = `Asset Found! Redirecting...`;
                scanner.clear().catch(error => console.error("Failed to clear scanner.", error));
                
                // Redirect after a short delay to allow the user to see the message
                setTimeout(() => {
                    window.location.href = pdfUrl;
                }, 500);

            } else {
                statusMessageEl.textContent = `Asset ID "${decodedText}" not found. Please try again.`;
                statusMessageEl.style.color = 'orange';
                setTimeout(() => {
                    statusMessageEl.textContent = 'Ready to scan.';
                    statusMessageEl.style.color = '#333';
                }, 3000);
            }
        }
        
        // Main function to start the application
        async function main() {
            // First, await the data loading
            const dataLoaded = await loadAssetData();
            
            // ONLY if data loading was successful, start the camera
            if (dataLoaded) {
                statusMessageEl.textContent = 'Ready to scan. Please grant camera permission.';
                scannerEl.style.display = 'block'; // Show the scanner element

                scanner = new Html5QrcodeScanner(
                    "qr-reader", 
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    /* verbose= */ false
                );
                scanner.render(onScanSuccess);
            } else {
                // If data failed to load, hide the scanner box
                 scannerEl.style.display = 'none';
            }
        }

        // Run the main function when the page is ready
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
